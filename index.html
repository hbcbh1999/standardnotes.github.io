<!DOCTYPE html>
<html lang='en-us' ng-app='app'>
  <head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <meta charset='UTF-8'>
    <title>Standard Notes Protocol by standardnotes</title>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link href='vendor/stylesheets/main.css' media='screen' rel='stylesheet' type='text/css'>
    <script src='https://code.angularjs.org/1.5.8/angular.js'></script>
    <script src='javascripts/rest_api.js'></script>
    <script src='javascripts/app.js'></script>
    <script src='javascripts/gumshoe.min.js'></script>
  </head>
  <body ng-controller='AppCtrl'>
    <section class='main-content'>
      <ul class='menu' data-gumshoe=''>
        <li>
          <a href='#preamble'>Preamble</a>
        </li>
        <li>
          <a href='#implementations'>Implementations</a>
        </li>
        <li>
          <a href='#introduction'>Introduction</a>
        </li>
        <li>
          <a href='#models'>Models</a>
          <ul class='no-bullets nested'>
            <li>
              <a href='#user'>User</a>
            </li>
            <li>
              <a href='#items'>Items</a>
            </li>
          </ul>
        </li>
        <li>
          <a href='#api'>REST API</a>
          <ul class='no-bullets nested'>
            <li>
              <a href='#apiauth'>Auth</a>
            </li>
            <li>
              <a href='#apiusers'>Users</a>
            </li>
            <li>
              <a href='#apiitems'>Items</a>
            </li>
          </ul>
        </li>
        <li>
          <a href='#importexport'>Import/Export</a>
        </li>
        <li>
          <a href='#encryption'>Encryption</a>
          <ul class='no-bullets nested'>
            <li>
              <a href='#encryptionkey'>Key Generation</a>
            </li>
            <li>
              <a href='#encryptionitem'>Item Encryption</a>
            </li>
          </ul>
        </li>
        <li>
          <a href='#sharing'>Sharing/Publishing</a>
        </li>
      </ul>
      <div class='header'>
        <h1 class='project-name'>Standard Notes</h1>
        <div class='project-tagline'>Decentralized Personal Notes. Open, secure, yours.</div>
        <div class='email-subscribe-wrapper'>
          <div class='content'>
            <div class='title'>Want to be involved in the future of notes?</div>
            <div class='subtitle'>Subscribe to Standard Notes announcements.</div>
            <link href='//cdn-images.mailchimp.com/embedcode/slim-10_7.css' rel='stylesheet' type='text/css'>
            <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width: 100%;}
            </style>
            <div id='mc_embed_signup'>
              <form action='//standardnotes.us14.list-manage.com/subscribe/post?u=f703bdd7fd7cd0923a94b3bd3&amp;id=8523dd24a8' class='validate' id='mc-embedded-subscribe-form' method='post' name='mc-embedded-subscribe-form' novalidate='' target='_blank'>
                <div id='mc_embed_signup_scroll'>
                  <input class='email' id='mce-EMAIL' name='EMAIL' placeholder='email address' required='' type='email' value=''>
                  <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups -->
                  <div aria-hidden='true' style='position: absolute; left: -5000px;'>
                    <input name='b_f703bdd7fd7cd0923a94b3bd3_8523dd24a8' tabindex='-1' type='text' value=''>
                  </div>
                  <div class='clear'>
                    <input class='button' id='mc-embedded-subscribe' name='subscribe' type='submit' value='Subscribe'>
                  </div>
                </div>
              </form>
            </div>
            <div class='social'>
              <a class='icon-twitter' href='https://twitter.com/standardnotes' target='_blank'></a>
              <a class='icon-github' href='https://github.com/standardnotes' target='_blank'></a>
              <a class='icon-reddit' href='https://www.reddit.com/r/StandardNotes/' target='_blank'></a>
            </div>
          </div>
        </div>
      </div>
      <p class='condensed'>Protocol Specification</p>
      <p class='condensed small faded'>Version 0.10.0</p>
      <h2><a aria-hidden='true' class='anchor' href='#preamble' id='preamble'></a>Preamble
      </h2>
      <p>Notes are an essential part of human life, a tradition dating back tens of thousands of years. A person a thousand years ago may not have had much: a home, some food, family, and quite often, a journal. These thoughts, scribbled down on paper, belonged to no one but the authors themselves.</p>
      <p>Today, our notes are owned by Evernote Incorporated; by Google Incorporated; by Apple Inc. We do not own our own notes. They are owned by for-profit corporations, who are today at the mercy of paranoid governments looking to extend their reach as far as possible.</p>
      <p>These platforms also typically lock you in, so that it's either difficult or inconvenient to transfer to another service.</p>
      <p>Standard Notes is an open specification for a simple and secure system of organizing notes and groups of notes, and also publishing groups and notes onto the internet. Because it is an open protocol, a user need not be locked in to any application. Indeed, a user may even use multiple applications on different platforms to manage the same dataset.</p>
      <h2><a aria-hidden='true' class='anchor' href='#implementations' id='implementations'></a>Implementations
      </h2>
      <a class='block-link' href='https://github.com/standardnotes/ruby-server' target='_blank'>Ruby Server Implementation</a>
      <a class='block-link' href='https://github.com/neeto-project/neeto-web-client' target='_blank'>Javascript Client Implementation</a>
      <a class='block-link' href='https://neeto.io' target='_blank'>Web Client</a>
      <h2><a aria-hidden='true' class='anchor' href='#introduction' id='introduction'></a>Introduction
      </h2>
      <p>This document outlines the specifications for the client-server communications of the Standard Notes system. Any client can communicate with a Standard Notes server as long as it understands the server's requirements.</p>
      <h1><a aria-hidden='true' class='anchor' href='#models' id='models'></a>Models
      </h1>
      <p>The protocol consists of models on the server side and what are known as structures on the client side.</p>
      <strong>Server Models</strong>
      <ul>
        <li>User</li>
        <li>Item</li>
      </ul>
      <strong>Client Structures</strong>
      <ul>
        <li>Note</li>
        <li>Tag</li>
      </ul>
      <p>An <code>Item</code> model has a <code>content</code> field. The <code>content</code> field stores a JSON encoded structure that can be, in this case, a Note or a Tag.</p>
      <p>In this client-server model, servers are to be treated as dumb and uninformed. Because data is encrypted anyway, maintaining relationships between server side models is not very useful.</p>
      <p>The SN model pushes relationship mapping to the client, which clients today have no problem handling. This allows for improvements to be made to the data model on the client level, and not on the difficult-to-change server level.</p>
      <p>(You'll also notice that clients are not restricted to building just a notes app with this data model. You can build almost anything that can represent data as a JSON encoded object. Notes are a good place to start however.)</p>
      <h2>Server Models</h2>
      <p>All server models must have the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>uuid</td>
            <td>String (or uuid for some databases)</td>
            <td>The unique identifier for this model.</td>
          </tr>
        </tbody>
      </table>
      <h3><a aria-hidden='true' class='anchor' href='#user' id='user'></a>User
      </h3>
      <p>A user model has the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>email</td>
            <td>Integer</td>
            <td>The email of the user.</td>
          </tr>
          <tr>
            <td>password</td>
            <td>String</td>
            <td>
              The password for this user.
              <em>Note that passwords must be manipulated before being sent to the server. See here.</em>
            </td>
          </tr>
          <tr>
            <td>
              username (<em>optional</em>)
            </td>
            <td>String</td>
            <td>A unique username used for sharing items. For servers that manage multiple Users, the username serves as a way to namespace presentations.</td>
          </tr>
        </tbody>
      </table>
      <h3><a aria-hidden='true' class='anchor' href='#items' id='items'></a>Items
      </h3>
      <p>Item models have the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>content</td>
            <td>Text</td>
            <td>The JSON string encoded structure of the note, encrypted (with some exceptions. See Sharing for details.).</td>
          </tr>
          <tr>
            <td>content_type</td>
            <td>String</td>
            <td>The type of the structure contained in the <code>content</code> field.</td>
          </tr>
          <tr>
            <td>loc_eek</td>
            <td>String</td>
            <td>The locally encrypted encryption key for this item.</td>
          </tr>
          <tr>
            <td>presentation_name</td>
            <td>String</td>
            <td>The name of this presentation, if applicable. (See Sharing for details).</td>
          </tr>
          <tr>
            <td>created_at</td>
            <td>Date</td>
            <td>The date this item was created.</td>
          </tr>
          <tr>
            <td>updated_at</td>
            <td>Date</td>
            <td>The date this item was modified.</td>
          </tr>
        </tbody>
      </table>
      <h2>Client Structures</h2>
      <p>Client structures are stored in the <code>content</code> field of the <code>Item</code> model. All client structures have the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>references</td>
            <td>Array</td>
            <td>
              A metadata array of other <code>Item</code> uuids this model is related to and their respective <code>content_type</code>:
              <br>
              <br>
              <pre><code>[&#x000A;  {uuid: xxxx, content_type: "Tag"},&#x000A;  {uuid: xxxxx, content_type: "Tag"},&#x000A;]</code></pre>
            </td>
          </tr>
        </tbody>
      </table>
      <h3><a aria-hidden='true' class='anchor' href='#notes' id='notes'></a>Notes
      </h3>
      <p>Note structure have the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>title</td>
            <td>String</td>
            <td>The title of the note.</td>
          </tr>
          <tr>
            <td>text</td>
            <td>String</td>
            <td>The text body of the note.</td>
          </tr>
        </tbody>
      </table>
      <h3><a aria-hidden='true' class='anchor' href='#tags' id='tags'></a>Tags
      </h3>
      <p>Tag structure have the following properties:</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>type</th>
            <th>description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>title</td>
            <td>String</td>
            <td>The title of the tag.</td>
          </tr>
        </tbody>
      </table>
      <h1><a aria-hidden='true' class='anchor' href='#api' id='api'></a>REST API
      </h1>
      <p>General:</p>
      <ol>
        <li>
          <p>
            All requests after the initial authentication should be authenticated with a JWT with the
            <code>Authorization</code>
            header:
          </p>
          <pre><code>Authorization: Bearer _insert_JWT_here_</code></pre>
        </li>
        <li>
          All responses include the object in question
          <em>nested</em>.
        </li>
      </ol>
      <h2><a aria-hidden='true' class='anchor' href='#apiauth' id='apiauth'></a>Auth
      </h2>
      <p>Standard Notes uses JSON Web Tokens (JWT) for authentication.</p>
      <div class='endpoints'>
        <div class='endpoint' ng-repeat='request in apiData.auth'>
          <div class='path'>{{request.verb}} {{request.path}}</div>
          <div class='desc'>{{request.desc}}</div>
          <div class='params'>
            Params:
            <span ng-repeat='param in request.params'>
              {{param.name}}
              <span ng-if='param.desc'>— {{param.desc}}</span>
            </span>
          </div>
          <div class='responses'>
            <div class='strong small'>Responses</div>
            <div class='response' ng-repeat='response in request.responses'>
              {{response.status}}
              <pre><code>{{response.body}}</code></pre>
            </div>
          </div>
        </div>
      </div>
      <h2><a aria-hidden='true' class='anchor' href='#apiusers' id='apiusers'></a>Users
      </h2>
      <div class='endpoints'>
        <div class='endpoint' ng-repeat='request in apiData.users'>
          <div class='path'>{{request.verb}} {{request.path}}</div>
          <div class='desc'>{{request.desc}}</div>
          <div class='params'>
            Params:
            <span ng-repeat='param in request.params'>
              {{param.name}}
              <span ng-if='param.desc'>— {{param.desc}}</span>
            </span>
          </div>
          <div class='responses'>
            <div class='strong small'>Responses</div>
            <div class='response' ng-repeat='response in request.responses'>
              {{response.status}}
              <pre><code>{{response.body}}</code></pre>
            </div>
          </div>
        </div>
      </div>
      <h2><a aria-hidden='true' class='anchor' href='#apiitems' id='apiitems'></a>Items
      </h2>
      <div class='endpoints'>
        <div class='endpoint' ng-repeat='request in apiData.items'>
          <div class='path'>{{request.verb}} {{request.path}}</div>
          <div class='desc'>{{request.desc}}</div>
          <div class='params'>
            Params:
            <span ng-repeat='param in request.params'>
              {{param.name}} 
              <span ng-if='param.desc'>— {{param.desc}}</span>
            </span>
          </div>
          <div class='responses'>
            <div class='strong small'>Responses</div>
            <div class='response' ng-repeat='response in request.responses'>
              {{response.status}}
              <pre><code>{{response.body}}</code></pre>
            </div>
          </div>
        </div>
      </div>
      <h2><a aria-hidden='true' class='anchor' href='#importexport' id='importexport'></a>Import/Export
      </h2>
      <p>The export file is a JSON file of all the user's items, unencrypted.</p>
      <p>
        <strong>Format:</strong>
      </p>
      <pre><code>{&#x000A;  "items": [&#x000A;    {&#x000A;      "uuid": "3162fe3a-1b5b-4cf5-b88a-afcb9996b23a",&#x000A;      "content_type": "Note",&#x000A;      "presentation_name": null,&#x000A;      "content": {&#x000A;        "references": [&#x000A;          {&#x000A;            "uuid": "901751a0-0b85-4636-93a3-682c4779b634",&#x000A;            "content_type": "Tag"&#x000A;          },&#x000A;          {&#x000A;            "uuid": "023112fe-9066-481e-8a63-f15f27d3f904",&#x000A;            "content_type": "Tag"&#x000A;          }&#x000A;        ],&#x000A;        "title": "...",&#x000A;        "text": "..."&#x000A;      },&#x000A;      "created_at": "2016-12-16T17:37:50.000Z"&#x000A;    },&#x000A;&#x000A;    {&#x000A;      "uuid": "023112fe-9066-481e-8a63-f15f27d3f904",&#x000A;      "content_type": "Tag",&#x000A;      "presentation_name": "essays",&#x000A;      "content": {&#x000A;        "references": [&#x000A;          {&#x000A;            "uuid": "94cba6b7-6b55-41d6-89a5-e3db8be9fbbf",&#x000A;            "content_type": "Note"&#x000A;          },&#x000A;          {&#x000A;            "uuid": "ada3ff00-85fa-4427-a883-652a84736715",&#x000A;            "content_type": "Note"&#x000A;          },&#x000A;          {&#x000A;            "uuid": "3162fe3a-1b5b-4cf5-b88a-afcb9996b23a",&#x000A;            "content_type": "Note"&#x000A;          }&#x000A;        ],&#x000A;        "title": "essays"&#x000A;      },&#x000A;      "created_at": "2016-12-16T17:13:20.000Z"&#x000A;    }&#x000A;  ]&#x000A;}</code></pre>
      <p>High-level flow, user wants to switch clients and servers:</p>
      <ol>
        <li>User chooses "Export" option on client A, which is paired with server A.</li>
        <li>Client produces JSON file with all items unencrypted.</li>
        <li>User uploads JSON file with client B paired with Server B.</li>
        <li>Client B iterates over items and encrypts the content of each of them locally. (Sharing exceptions apply, see Sharing.)</li>
        <li>Client B sends updated JSON (with encrypted item content) data to server B.</li>
      </ol>
      <div class='endpoints'>
        <div class='endpoint' ng-repeat='request in apiData.import'>
          <div class='path'>{{request.verb}} {{request.path}}</div>
          <div class='desc'>{{request.desc}}</div>
          <div class='params'>
            <span ng-repeat='param in request.params'>
              {{param.name}} 
              <span ng-if='param.desc'>— {{param.desc}}</span>
            </span>
          </div>
          <div class='responses'>
            <div class='strong small'>Responses</div>
            <div class='response' ng-repeat='response in request.responses'>
              {{response.status}}
              <pre><code>{{response.body}}</code></pre>
            </div>
          </div>
        </div>
      </div>
      <h1>
        <a aria-hidden='true' class='anchor' href='#encryption' id='encryption'></a>
        Encryption
      </h1>
      <p>Encryption and security should always be top of mind with Standard Notes.</p>
      <p>It is important that there exist a separation of concerns between the server and the client. That is, the client should not trust the server, and vice versa. Encryption keys are generated by stretching the user's input password using PBKDF2. The resulting 512 bit key is then split in two - the first half is sent to the server as the user's password, and the second half is saved locally as the user's master encryption key. This way, the server can never calculate the encryption key.</p>
      <p>The following are general requirements for clients and servers:</p>
      <ol>
        <li>
          Item
          <code>content</code>
          must be encrypted locally before being sent to server.
        </li>
        <li>Client-server connections must be made securely through SSL/TLS.</li>
        <li>Upon receiving data from client, servers should encrypt sensitive data once more before storing with a key only the server knows. The server should decrypt this data before sending back to client.</li>
      </ol>
      <h2>
        <a aria-hidden='true' class='anchor' href='#encryptionkey' id='encryptionkey'></a>
        User Password Encryption and Key Generation
      </h2>
      <p>
        <strong>Client-side:</strong>
      </p>
      <ol>
        <li>
          User enters "user inputted password" (<code>uip</code>) into registration or login password field.
        </li>
        <li>
          Client manipulates
          <code>uip</code>
          before sending to server as
          <code>password</code>:
          <ol type='a'>
            <li>
              Stretch
              <code>uip</code>
              using PBKDF2 with 3000 iterations, SHA512 as hashing algorithm, and user's email as salt.
            </li>
            <li>
              Split result from (a) in two halves:
              <br>
              - First half will be the
              <code>password</code>
              sent to the server.
              <br>
              - Second half will be the user's global encryption key (<code>gk</code>) (stored locally and never sent to server.)
            </li>
          </ol>
        </li>
      </ol>
      <h2>
        <a aria-hidden='true' class='anchor' href='#encryptionitem' id='encryptionitem'></a>
        Item Encryption
      </h2>
      <p>
        <strong>Client-side:</strong>
      </p>
      <p>An item is encrypted using a random key locally generated for each item.</p>
      <p>For every item,</p>
      <p>
        <strong>If item is not public:</strong>
      </p>
      <ol>
        <li>
          Generate a random key
          <code>ek</code>.
        </li>
        <li>
          Encrypt
          <code>content</code>
          using AES with
          <code>ek</code>
          as the secret.
        </li>
        <li>
          Generate locally encrypted encryption key
          <code>loc_eek</code>
          by encrypting
          <code>ek</code>
          using AES and
          <code>gk</code>
          as the secret.
        </li>
        <li>
          Send
          <code>content</code>
          and
          <code>loc_eek</code>
          to the server. (Do not send
          <code>ek</code>,
          which can be used to decrypt the item.)
        </li>
      </ol>
      <p>
        <strong>If item is public or belongs to public item:</strong>
      </p>
      <ol>
        <li>
          Set <code>lok_eek</code> to null and send
          <code>content</code>
          in plain text to server.
        </li>
      </ol>
      <p>
        Generating a unique key for every item allows for easier changing of a user's password — only the item's
        <code>ek</code>
        will have to be re-encrypted with the new
        <code>gk</code>,
        and not the entire contents of the item.
      </p>
      <p>
        <strong>Server-side:</strong>
      </p>
      <p>For every received item:</p>
      <ol>
        <li>
          Encrypt
          <code>content</code>
          using server known key and store.
          Decrypt before sending back to client.
        </li>
      </ol>
      <h1>
        <a aria-hidden='true' class='anchor' href='#sharing' id='sharing'></a>
        Sharing/Publishing
      </h1>
      <p>When an item is shared, it is accessible by the public. To share an item, you set a value for <code>presentation_name</code> on the item.</p>
      <p>When presenting, the client must remove local encryption from the item and all other referenced items the client deems related.</p>
      <p>When un-presenting an item, the client must encrypt the item and all other referenced items the client deems related.</p>
      <footer class='site-footer'>
        <span class='site-footer-owner'>
          <a href='https://github.com/standardnotes'>Standard Notes</a>
          is maintained by
          <a href='https://github.com/standardnotes'>standardnotes</a>.
        </span>
      </footer>
    </section>
  </body>
</html>
